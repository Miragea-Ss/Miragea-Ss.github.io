---
// src/pages/[lang]/gallery/[tag].astro
import Layout from '../../../layouts/Layout.astro';
import InfiniteGallery from '../../../components/InfiniteGallery.astro';
import allWorks from '../../../data/works.json';

// 1. ページ生成（works.json にある全てのタグのページを作る）
export async function getStaticPaths() {
  // works.json からタグを抽出
  const uniqueTags = [...new Set(allWorks.flatMap(work => work.tags))];
  
  // もし works.json が空っぽでもエラーにならないように対策
  if (uniqueTags.length === 0) {
    uniqueTags.push('New'); 
  }

  const languages = ['en', 'ja', 'zh'];

  // 言語 × タグ の組み合わせを作る
  return languages.flatMap(lang => 
    uniqueTags.map(tag => ({
      params: { lang, tag },
      props: { lang, tag }
    }))
  );
}

const { lang, tag } = Astro.props;

// 2. そのタグが付いている画像だけを選び出す
const filteredWorks = allWorks.filter(work => work.tags.includes(tag));

const uiText = {
  en: { back: "← Surface", layer: "Layer" },
  ja: { back: "← 表層へ戻る", layer: "画層" },
  zh: { back: "← 返回表层", layer: "图层" }
};
const t = uiText[lang] || uiText.en;
---

<Layout title={`#${tag} | MIRAGEA Archive`} lang={lang}>
  <main class="min-h-screen bg-black text-gray-200">
    
    <!-- ヘッダーエリア -->
    <div class="pt-12 pb-8 px-6 md:px-12 flex flex-col items-center relative z-10">
      
      <!-- 戻るボタン -->
      <a href={`/${lang}`} class="absolute left-6 top-12 text-xs font-mono text-gray-500 hover:text-white transition-colors tracking-widest no-underline">
        {t.back}
      </a>

      <!-- タグタイトル -->
      <h1 class="text-5xl md:text-7xl font-thin tracking-tighter text-transparent bg-clip-text bg-gradient-to-b from-white to-gray-800 mb-4 animate-fade-in-up">
        #{tag}
      </h1>
      
      <!-- 件数表示 -->
      <p class="font-mono text-xs text-gray-600 tracking-[0.2em]">
        {t.layer} / {filteredWorks.length} ITEMS
      </p>
    </div>

    <!-- 無限スクロール画像エリア -->
    <div class="px-4 pb-32">
      <InfiniteGallery works={filteredWorks} lang={lang} />
    </div>

  </main>
</Layout>

<style>
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate-fade-in-up {
    animation: fadeInUp 1s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
  }
</style>